machine:
  ruby:
    version: 2.1.0
  # https://discuss.circleci.com/t/docker-1-10-0-is-available-beta/2100
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    - pip install docker-compose
  services:
    - docker

database:
  pre:
    - sudo service mongodb stop

    - mkdir -p $HOME/data/mongod1
    - mkdir -p $HOME/data/mongod2
    - mkdir -p $HOME/data/mongod3
    - mkdir -p $HOME/data/mongoc1
    - mkdir $HOME/log

    - mongod --shardsvr --dbpath $HOME/data/mongod1 --logpath $HOME/log/mongod1.log --port 27031 --fork
    - mongod --shardsvr --dbpath $HOME/data/mongod2 --logpath $HOME/log/mongod2.log --port 27032 --fork
    - mongod --shardsvr --dbpath $HOME/data/mongod3 --logpath $HOME/log/mongod3.log --port 27033 --fork
    - mongod --configsvr --dbpath $HOME/data/mongoc1 --logpath $HOME/log/mongoc1.log --port 27011 --fork
    - mongos --configdb localhost:27011 --logpath $HOME/log/mongos1.log --chunkSize 1 --port 27017 --fork

    - 'mongo admin --eval ''db.runCommand({"addShard":"localhost:27031"})'''
    - 'mongo admin --eval ''db.runCommand({"addShard":"localhost:27032"})'''
    - 'mongo admin --eval ''db.runCommand({"addShard":"localhost:27033"})'''
    - 'mongo admin --eval ''db.adminCommand({"enableSharding":"circle_test"})'''
    - 'mongo admin --eval ''db.adminCommand({"shardCollection":"circle_test.blogs", "key":{"user_id": 1}})'''

    - 'mongo admin --eval ''db.printShardingStatus()'''

